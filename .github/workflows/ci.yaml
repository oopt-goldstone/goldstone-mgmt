name: ci
on:
  workflow_dispatch:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
      -
        name: Checkout yang2-rs submodule
        run: "cd sm/sysrepo2-rs && git submodule update --init"
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          install: true
      -
        name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ghcr.io/oopt-goldstone/mgmt/tester
      -
        name: Build Tester
        uses: docker/build-push-action@v3
        with:
          context: .
          load: true
          file: "./docker/builder.Dockerfile"
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          target: tester
          cache-from: type=gha
          cache-to: type=gha,mode=max
      -
        name: Lint
        run: "docker run -t -v `pwd`:`pwd` -w `pwd` ${{ steps.meta.outputs.tags }} make lint"
      -
        name: Unittest
        run: "docker run -t -v `pwd`:`pwd` -w `pwd` ${{ steps.meta.outputs.tags }} make unittest"
  rust:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
      -
        name: Checkout yang2-rs submodule
        run: "cd sm/sysrepo2-rs && git submodule update --init"
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          install: true
      -
        name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ghcr.io/oopt-goldstone/mgmt/rust-tester
      -
        name: Build Tester
        uses: docker/build-push-action@v3
        with:
          context: .
          load: true
          file: "./docker/builder.Dockerfile"
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          target: rust-tester
          cache-from: type=gha
          cache-to: type=gha,mode=max
      -
        name: Unittest
        run: "docker run -t -v `pwd`:`pwd` -w `pwd` ${{ steps.meta.outputs.tags }} make rust-unittest"
